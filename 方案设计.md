# 🤖 Telegram 媒体合并/相册机器人 - 项目文档

## 📖 1. 项目简介
本项目是一个功能强大的 Telegram 机器人，核心功能是接收用户发送的多张图片或视频，并将它们**整理成相册 (Media Group)** 发送给用户。同时也保留了将多张图片**拼接**成相册的功能。

---

## 🚀 2. 核心功能

| 功能模式 | 触发方式 | 描述 |
| :--- | :--- | :--- |
| **相册模式 (默认)** | 直接发送图片/视频 -> `/end` | 将分散发送的多张图片/视频打包成一个消息组（Album）发送，整洁美观。 |
| **拼接模式** | `/vertical` 或 `/horizontal` | 将多张图片物理拼接成一张长图（垂直或水平）。 |
| **自动清理** | 每次处理后 | 自动清理服务器上的临时文件，节省空间。 |
| **防休眠** | 内置 Web Server | 配合外部监控服务，防止云平台实例休眠。 |

---

## 📋 3. 使用流程 (用户视角)

1.  **启动**: 发送 `/start` 唤醒机器人。
2.  **发送媒体**: 连续发送多张图片或视频。
    *   *机器人回复: "已收到第 x 个文件"*
3.  **处理**: 发送 `/end`。
    *   **默认**: 机器人将文件按相册格式发回。
    *   **拼接**: 如果之前发送了 `/vertical`，机器人将发回一张拼接好的长图。
4.  **重置**: 发送 `/clear` 可清空当前队列。

---

## 🛠️ 4. 技术架构
*   **语言**: Python 3.9+
*   **Bot 框架**: `python-telegram-bot` (v20+)
*   **Web 服务**: `Flask` (用于健康检查和防休眠)
*   **图像处理**: `Pillow`
*   **视频处理**: `moviepy` (版本锁定 < 2.0 以兼容旧 API)
*   **部署容器**: `Docker` (自动安装 FFmpeg 和 Python 环境)

---

## ☁️ 5. 部署方案 (推荐 Koyeb)

经过测试，**Koyeb** 是目前最适合本项目的免费部署平台。

### 🚀 部署步骤
1.  注册 [Koyeb](https://www.koyeb.com/)。
2.  创建新 App，选择 **GitHub** 部署。
3.  选择本仓库 `telegramhebingbot`。
4.  **关键设置**:
    *   **Builder**: 选择 **Dockerfile** (确保安装 FFmpeg)。
    *   **Environment Variables** (可选): 可以设置 `BOT_TOKEN` (虽然代码里已内置，但环境变量更安全)。
5.  点击 **Deploy**。

### 💤 如何防止休眠？
本项目已内置一个 Web Server 监听 `8000` 端口。
1.  部署成功后，Koyeb 会提供一个公网域名 (例如 `https://xxx.koyeb.app`)。
2.  使用 [UptimeRobot](https://uptimerobot.com/) 或类似服务，每 5-10 分钟请求一次该域名。
3.  只要有请求，实例就会保持活跃。

---

## ⚠️ 6. 开发过程问题与解决方案 (复盘)

在开发和部署过程中，我们遇到了以下挑战并逐一解决：

### 🔴 问题 1: Railway 账户限制
*   **现象**: Railway 对未验证信用卡的新账户禁止部署服务，只允许部署数据库。
*   **解决**: 迁移至 **Koyeb** 平台，它提供免费且无需信用卡的 Nano 实例。

### 🔴 问题 2: Koyeb 健康检查失败 (Service Unhealthy)
*   **现象**: 机器人启动后，Koyeb 显示 "Service Unhealthy" 并不断重启。
*   **原因**: Koyeb 默认会检查 `8000` 端口的 TCP/HTTP 连接。纯 Bot 脚本不监听端口，导致检查失败。
*   **解决**: 引入 `Flask` 库，在后台启动一个轻量级 Web Server 监听 `0.0.0.0:8000`，专门用于响应健康检查。

### 🔴 问题 3: MoviePy 版本报错
*   **现象**: 运行视频功能时报错 `ModuleNotFoundError: No module named 'moviepy.editor'`。
*   **原因**: `pip` 默认安装了 MoviePy 2.0+，该版本移除了 `editor` 子模块，导致代码不兼容。
*   **解决**: 在 `requirements.txt` 中强制锁定版本 `moviepy<2.0`，确保兼容性。

### 🔴 问题 4: 功能理解偏差
*   **现象**: 初始版本默认将图片拼成一张长图，而用户期望的是 Telegram 的 "相册" (Media Group) 效果。
*   **解决**: 修改 `main.py` 逻辑，将 **相册模式** 设为默认行为，保留拼接模式作为可选功能。

---

## ✅ 7. 当前状态
*   [x] **核心代码**: 完整 (`main.py`, `merger.py`)。
*   [x] **依赖管理**: 修正 (`requirements.txt` 锁定版本)。
*   [x] **部署配置**: 完善 (`Dockerfile` 含 FFmpeg, EXPOSE 8000)。
*   [x] **平台适配**: Koyeb 适配完成 (Flask 保活)。
*   [x] **功能调整**: 默认为相册模式，符合用户预期。

🎉 **项目已就绪，可直接部署使用。**
